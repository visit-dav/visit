#!/bin/sh
#-----------------------------------------------------------------------
#
# VISIT-BUILD-OPEN - Build the visit distributions on the open network.
#
# Author: Eric Brugger
# Date:   October 27, 2000
#
# Usage:
#    visit-build-open -d <distribution>
#
# Modifications:
#   Brad Whitlock, Fri Dec 15 09:51:55 PDT 2006
#   Added --enable-visitmodule for some platforms.
#
#   Hank Childs, Mon Oct 15 09:04:12 PDT 2007
#   Add some print statements for usability.  Also make sure that 
#   /usr/bin/X11 is in the path for yana and prism.  If you are a ksh
#   user, your environment will not get sourced and xmkmf will not be
#   found, leading configure to not find the right X libraries, which 
#   will lead to a compile error.
#
#   Hank Childs, Wed Oct 17 14:28:48 PDT 2007
#   Add support for ksh users on sunspot.  (Default environment
#   inherited by "sh" is not enough to do a compile.)
#
#   Hank Childs, Wed Oct 17 16:25:14 PDT 2007
#   Add a subject line to the status e-mails.  Also workaround problem
#   with quad mailing out.
#
#   Hank Childs, Mon Oct 22 09:25:47 PDT 2007
#   More ksh sunspot fixes.
#
#   Hank Childs, Sat Feb  9 14:18:54 PST 2008
#   Change clearcase_bin to svn_bin.
#
#   Brad Whitlock, Fri Oct 10 15:25:27 PST 2008
#   Added --enable-slivr to some of the Linux targets.
#
#-----------------------------------------------------------------------

test=no

user=`whoami`

#
# Set the user e-mail address.
#
emailName=brugger1@llnl.gov
case $user in
   kbonnell)
      emailName=bonnell2@llnl.gov
      ;; 
   brugger)
      emailName=brugger1@llnl.gov
      ;;
   childs)
      emailName=childs3@llnl.gov
      ;;
   mcmiller)
      emailName=miller86@llnl.gov
      ;;
   miller)
      emailName=miller86@llnl.gov
      ;;
   whitlocb)
      emailName=whitlock2@llnl.gov
      ;;
esac

#
# Parse the execute line, providing default values for error checking.
#
hoth=true
sunspot=true
quad=true
up=true
pengra=true
thunder=true
yana=true
xchem=true
davinci=true
ellipse=true

dist=undefined

#
# The loop is executed once for each symbol on the execute line.  This means
# that $1 may be blank for later executions of the loop if any "shift 2"
# commands are executed.  The variable abc is not used in the loop.  
#
for abc
do
   case $1 in
      -none)
         hoth=false
         sunspot=false
         quad=false
         up=false
         pengra=false
         thunder=false
         yana=false
         xchem=false
         davinci=false
         ellipse=false
         shift
         ;;
      -hoth)
         hoth=false
         shift
         ;;
      +hoth)
         hoth=true
         shift
         ;;
      -sunspot)
         sunspot=false
         shift
         ;;
      +sunspot)
         sunspot=true
         shift
         ;;
      -quad)
         quad=false
         shift
         ;;
      +quad)
         quad=true
         shift
         ;;
      -up)
         up=false
         shift
         ;;
      +up)
         up=true
         shift
         ;;
      -pengra)
         pengra=false
         shift
         ;;
      +pengra)
         pengra=true
         shift
         ;;
      -thunder)
         thunder=false
         shift
         ;;
      +thunder)
         thunder=true
         shift
         ;;
      -yana)
         yana=false
         shift
         ;;
      +yana)
         yana=true
         shift
         ;;
      -xchem)
         xchem=false
         shift
         ;;
      +xchem)
         xchem=true
         shift
         ;;
      -davinci)
         davinci=false
         shift
         ;;
      +davinci)
         davinci=true
         shift
         ;;
      -ellipse)
         ellipse=false
         shift
         ;;
      +ellipse)
         ellipse=true
         shift
         ;;
      -d)
         dist=$2
         shift 2
         ;;
   esac
done

#
# Check that the distribution name was provided.
#
if [ $dist = undefined ]
then
   echo "Usage: [-none] [-<machine name>] -d <distribution>"
   echo "Valid machine names:"
   echo "    hoth (B-Div, Linux),"
   echo "    sunspot (B-Div, Solaris),"
   echo "    quad (LC, SGI),"
   echo "    up (LC, AIX),"
   echo "    pengra (LC, Linux, x86_64),"
   echo "    thunder (LC, Linux, ia64),"
   echo "    yana (LC, Linux, x86_64),"
   echo "    xchem (HEAF, Linux),"
   echo "    davinci (LBNL, Altix),"
   echo "    ellipse (UChicago, Linux)"
   exit
fi

#
# Check that the distribution exists.
#
distfile=$dist.tar.gz
if [ ! -f $distfile ]
then
   echo "Distribution file doesn't exist."
   exit
fi

#
# Build on hoth.
#
rm -f hoth
cat <<EOF > hoth
#!/bin/sh
if test ! -e /scratch/$user ; then
   mkdir /scratch/$user
fi
if test ! -e /scratch/$user/hoth ; then
   mkdir /scratch/$user/hoth
fi
rm -rf /scratch/$user/hoth/visitbuild
mkdir /scratch/$user/hoth/visitbuild
mv hoth_$dist.tar.gz /scratch/$user/hoth/visitbuild/$dist.tar.gz
cd /scratch/$user/hoth/visitbuild
gunzip -c $dist.tar.gz | tar xvf - > buildlog 2>&1
cd $dist/src
ver=\`cat VERSION\`
ver2=\`echo \$ver | tr "." "_"\`
env CXXFLAGS=-O2 ./configure --enable-parallel --enable-viewer-mesa-stub --enable-visitmodule --enable-slivr >> ../../buildlog 2>&1
make -j 4 >> ../../buildlog 2>&1
svn_bin/visit-bin-dist >> ../../buildlog 2>&1
mv visit\$ver2.linux.tar.gz ../..
cd ../..
rm -f resultlog
echo "        build of visit on hoth"         > resultlog 2>&1
echo "       ------------------------"        >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
ls -l                                         >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "number of database plugins = "\`ls $dist/src/plugins/databases/libI* | wc -l\` >> resultlog 2>&1
echo "number of operator plugins = "\`ls $dist/src/plugins/operators/libI* | wc -l\` >> resultlog 2>&1
echo "number of plot plugins = "\`ls $dist/src/plugins/plots/libI* | wc -l\` >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "The database plugins:"                  >> resultlog 2>&1
ls $dist/src/plugins/databases/libI* | sed "s/$dist\/src\/plugins\/databases\/libI//" | sed "s/Database.so//" >> resultlog 2>&1
mail  -s "VisIt build ($dist): hoth" $emailName < resultlog
EOF

if [ $hoth = true ]
then
   if [ $test = no ]
   then
      echo "Building on hoth"
      scp hoth hoth:hoth_buildit
      scp $dist.tar.gz hoth:hoth_$dist.tar.gz
      ssh hoth "chmod 750 hoth_buildit;./hoth_buildit" &
   fi
fi

#
# Build on sunspot.
#
rm -f sunspot
cat <<EOF > sunspot
#!/bin/sh

PATH=/usr/local/bin:/usr/ccs/bin:\$PATH
export PATH
LD_LIBRARY_PATH=/usr/local/lib:\$LD_LIBRARY_PATH
export LD_LIBRARY_PATH
if test ! -d /export/scratch/$user ; then
   mkdir /export/scratch/$user
fi
if test ! -d /export/scratch/$user/sunspot ; then
   mkdir /export/scratch/$user/sunspot
fi
rm -rf /export/scratch/$user/sunspot/visitbuild
mkdir /export/scratch/$user/sunspot/visitbuild
mv sunspot_$dist.tar.gz /export/scratch/$user/sunspot/visitbuild/$dist.tar.gz
cd /export/scratch/$user/sunspot/visitbuild
gunzip -c $dist.tar.gz | tar xvf - > buildlog 2>&1
cd $dist/src
ver=\`cat VERSION\`
ver2=\`echo \$ver | tr "." "_"\`
env CXXFLAGS=-O2 ./configure --enable-visitmodule >> ../../buildlog 2>&1
cd databases/Fluent
sed "s/\\\$(CXXFLAGSORIG)/-D_LARGEFILE64_SOURCE -Wall -Wno-sign-compare -Wno-deprecated/" Makefile > Makefile+;rm Makefile;mv Makefile+ Makefile
cd ../..
make -j 4 >> ../../buildlog 2>&1
svn_bin/visit-bin-dist >> ../../buildlog 2>&1
mv visit\$ver2.sunos5.tar.gz ../..
cd ../..
rm -f resultlog
echo "        build of visit on sunspot"      > resultlog 2>&1
echo "       ---------------------------"     >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
ls -l                                         >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "number of database plugins = "\`ls $dist/src/plugins/databases/libI* | wc -l\` >> resultlog 2>&1
echo "number of operator plugins = "\`ls $dist/src/plugins/operators/libI* | wc -l\` >> resultlog 2>&1
echo "number of plot plugins = "\`ls $dist/src/plugins/plots/libI* | wc -l\` >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "The database plugins:"                  >> resultlog 2>&1
ls $dist/src/plugins/databases/libI* | sed "s/$dist\/src\/plugins\/databases\/libI//" | sed "s/Database.so//" >> resultlog 2>&1
# sunspot can't handle a subject, so send mail through kickit
cp resultlog \$HOME/sunspot_resultlog
ssh kickit "cat sunspot_resultlog | /bin/mail  -s \"VisIt build ($dist): sunspot\" $emailName"
# give kickit time to mail it before removing the log
sleep 10
rm \$HOME/sunspot_resultlog
EOF

if [ $sunspot = true ]
then
   if [ $test = no ]
   then
      echo "Building on sunspot"
      scp sunspot sunspot:sunspot_buildit
      scp $dist.tar.gz sunspot:sunspot_$dist.tar.gz
      ssh sunspot "chmod 750 sunspot_buildit;./sunspot_buildit" &
   fi
fi

#
# Build on quad.
#
rm -f quad
cat <<EOF > quad
#!/bin/sh
if test ! -d /usr/tmp/$user ; then
   mkdir /usr/tmp/$user
fi
if test ! -d /usr/tmp/$user/quad ; then
   mkdir /usr/tmp/$user/quad
fi
rm -rf /usr/tmp/$user/quad/visitbuild
mkdir /usr/tmp/$user/quad/visitbuild
mv quad_$dist.tar.gz /usr/tmp/$user/quad/visitbuild/$dist.tar.gz
cd /usr/tmp/$user/quad/visitbuild
gunzip -c $dist.tar.gz | tar xvf - > buildlog 2>&1
cd $dist/src
ver=\`cat VERSION\`
ver2=\`echo \$ver | tr "." "_"\`
env CXXFLAGS=-O2 MAKE=gmake ./configure --enable-parallel --enable-visitmodule >> ../../buildlog 2>&1
gmake -j 4 >> ../../buildlog 2>&1
svn_bin/visit-bin-dist -make gmake >> ../../buildlog 2>&1
mv visit\$ver2.irix6.tar.gz ../..
cd ../..
rm -f resultlog
echo "        build of visit on quad"         > resultlog 2>&1
echo "       ------------------------"        >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
ls -l                                         >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "number of database plugins = "\`ls $dist/src/plugins/databases/libI* | wc -l\` >> resultlog 2>&1
echo "number of operator plugins = "\`ls $dist/src/plugins/operators/libI* | wc -l\` >> resultlog 2>&1
echo "number of plot plugins = "\`ls $dist/src/plugins/plots/libI* | wc -l\` >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "The database plugins:"                  >> resultlog 2>&1
ls $dist/src/plugins/databases/libI* | sed "s/$dist\/src\/plugins\/databases\/libI//" | sed "s/Database.so//" >> resultlog 2>&1
# quad can't mail out, so send mail through thunder
cp resultlog \$HOME/quad_resultlog
ssh thunder2 "cat quad_resultlog | /bin/mail  -s \"VisIt build ($dist): quad\" $emailName"
# give thunder time to mail it before removing the log
sleep 10
rm \$HOME/quad_resultlog
EOF

if [ $quad = true ]
then
   if [ $test = no ]
   then
      echo "Building on quad"
      scp quad quad:quad_buildit
      scp $dist.tar.gz quad:quad_$dist.tar.gz
      ssh quad "chmod 750 quad_buildit;./quad_buildit" &
   fi
fi

#
# Build on up, both serial and parallel versions.
#
rm -f up
cat <<EOF > up
#!/bin/sh
PATH=/usr/local/bin:\$PATH
if test ! -d /p/gup1/$user ; then
   mkdir /p/gup1/$user
fi
if test ! -d /p/gup1/$user/up ; then
   mkdir /p/gup1/$user/up
fi
rm -rf /p/gup1/$user/up/visitbuild
mkdir /p/gup1/$user/up/visitbuild
mv up_$dist.tar.gz /p/gup1/$user/up/visitbuild/$dist.tar.gz
cd /p/gup1/$user/up/visitbuild
gunzip -c $dist.tar.gz | tar xvf - > buildlog 2>&1
mv $dist ${dist}_32
cd ${dist}_32/src
ver=\`cat VERSION\`
ver2=\`echo \$ver | tr "." "_"\`
OBJECT_MODE=32
export OBJECT_MODE
env CXXFLAGS=-O2 MAKE=gmake ./configure --with-config=config-site/up041_32.conf --enable-visitmodule >> ../../buildlog 2>&1
gmake -j 4 >> ../../buildlog 2>&1
svn_bin/visit-bin-dist -make gmake >> ../../buildlog 2>&1
mv visit\$ver2.aix.tar.gz ../..
cd ../..
gunzip -c $dist.tar.gz | tar xvf - >> buildlog 2>&1
cd $dist/src
OBJECT_MODE=64
export OBJECT_MODE
env CXXFLAGS=-O2 MAKE=gmake ./configure --enable-parallel --enable-visitmodule >> ../../buildlog 2>&1
gmake -j 4 >> ../../buildlog 2>&1
svn_bin/visit-bin-dist -make gmake >> ../../buildlog 2>&1
mv visit\$ver2.aix64.tar.gz ../..
cd ../..
echo "        build of visit on up"           > resultlog 2>&1
echo "       ----------------------"          >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
ls -l                                         >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "            32 bit build"               >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "number of database plugins = "\`ls ${dist}_32/src/plugins/databases/libI* | wc -l\` >> resultlog 2>&1
echo "number of operator plugins = "\`ls ${dist}_32/src/plugins/operators/libI* | wc -l\` >> resultlog 2>&1
echo "number of plot plugins = "\`ls ${dist}_32/src/plugins/plots/libI* | wc -l\` >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "The database plugins:"                  >> resultlog 2>&1
ls ${dist}_32/src/plugins/databases/libI* | sed "s/${dist}_32\/src\/plugins\/databases\/libI//" | sed "s/Database.so//" >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "            64 bit build"               >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "number of database plugins = "\`ls $dist/src/plugins/databases/libI* | wc -l\` >> resultlog 2>&1
echo "number of operator plugins = "\`ls $dist/src/plugins/operators/libI* | wc -l\` >> resultlog 2>&1
echo "number of plot plugins = "\`ls $dist/src/plugins/plots/libI* | wc -l\` >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "The database plugins:"                  >> resultlog 2>&1
ls $dist/src/plugins/databases/libI* | sed "s/$dist\/src\/plugins\/databases\/libI//" | sed "s/Database.so//" >> resultlog 2>&1
mail  -s "VisIt build ($dist): up" $emailName < resultlog
EOF

if [ $up = true ]
then
   if [ $test = no ]
   then
      echo "Building on up"
      scp up up:up_buildit
      scp $dist.tar.gz up:up_$dist.tar.gz
      ssh up "chmod 750 up_buildit;./up_buildit" &
   fi
fi

#
# Build on pengra.
#
rm -f pengra
cat <<EOF > pengra
#!/bin/sh
if test ! -d /usr/tmp/$user ; then
   mkdir /usr/tmp/$user
fi
if test ! -d /usr/tmp/$user/pengra ; then
   mkdir /usr/tmp/$user/pengra
fi
rm -rf /usr/tmp/$user/pengra/visitbuild
mkdir /usr/tmp/$user/pengra/visitbuild
mv pengra_$dist.tar.gz /usr/tmp/$user/pengra/visitbuild/$dist.tar.gz
cd /usr/tmp/$user/pengra/visitbuild
gunzip -c $dist.tar.gz | tar xvf - > buildlog 2>&1
cd $dist/src
ver=\`cat VERSION\`
ver2=\`echo \$ver | tr "." "_"\`
env CXXFLAGS=-O2 ./configure --enable-parallel --enable-visitmodule >> ../../buildlog 2>&1
make -j 3 >> ../../buildlog 2>&1
svn_bin/visit-bin-dist >> ../../buildlog 2>&1
mv visit\$ver2.linux.tar.gz ../..
cd ../..
rm -f resultlog
echo "        build of visit on pengra"       > resultlog 2>&1
echo "       --------------------------"      >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
ls -l                                         >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "number of database plugins = "\`ls $dist/src/plugins/databases/libI* | wc -l\` >> resultlog 2>&1
echo "number of operator plugins = "\`ls $dist/src/plugins/operators/libI* | wc -l\` >> resultlog 2>&1
echo "number of plot plugins = "\`ls $dist/src/plugins/plots/libI* | wc -l\` >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "The database plugins:"                  >> resultlog 2>&1
ls $dist/src/plugins/databases/libI* | sed "s/$dist\/src\/plugins\/databases\/libI//" | sed "s/Database.so//" >> resultlog 2>&1
mail  -s "VisIt build ($dist): pengra" $emailName < resultlog
EOF

if [ $pengra = true ]
then
   if [ $test = no ]
   then
      echo "Building on pengra"
      scp pengra pengra1:pengra_buildit
      scp $dist.tar.gz pengra1:pengra_$dist.tar.gz
      ssh pengra1 "chmod 750 pengra_buildit;./pengra_buildit" &
   fi
fi

#
# Build on thunder.
#
rm -f thunder
cat <<EOF > thunder
#!/bin/sh
if test ! -d /usr/tmp/$user ; then
   mkdir /usr/tmp/$user
fi
if test ! -d /usr/tmp/$user/thunder ; then
   mkdir /usr/tmp/$user/thunder
fi
rm -rf /usr/tmp/$user/thunder/visitbuild
mkdir /usr/tmp/$user/thunder/visitbuild
mv thunder_$dist.tar.gz /usr/tmp/$user/thunder/visitbuild/$dist.tar.gz
cd /usr/tmp/$user/thunder/visitbuild
gunzip -c $dist.tar.gz | tar xvf - > buildlog 2>&1
cd $dist/src
ver=\`cat VERSION\`
ver2=\`echo \$ver | tr "." "_"\`
env CXXFLAGS=-O2 ./configure --enable-parallel --enable-visitmodule --enable-slivr >> ../../buildlog 2>&1
make -j 3 >> ../../buildlog 2>&1
svn_bin/visit-bin-dist >> ../../buildlog 2>&1
mv visit\$ver2.linux-ia64.tar.gz ../..
cd ../..
rm -f resultlog
echo "        build of visit on thunder"      > resultlog 2>&1
echo "       ---------------------------"     >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
ls -l                                         >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "number of database plugins = "\`ls $dist/src/plugins/databases/libI* | wc -l\` >> resultlog 2>&1
echo "number of operator plugins = "\`ls $dist/src/plugins/operators/libI* | wc -l\` >> resultlog 2>&1
echo "number of plot plugins = "\`ls $dist/src/plugins/plots/libI* | wc -l\` >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "The database plugins:"                  >> resultlog 2>&1
ls $dist/src/plugins/databases/libI* | sed "s/$dist\/src\/plugins\/databases\/libI//" | sed "s/Database.so//" >> resultlog 2>&1
mail  -s "VisIt build ($dist): thunder" $emailName < resultlog
EOF

if [ $thunder = true ]
then
   if [ $test = no ]
   then
      echo "Building on thunder"
      scp thunder thunder2:thunder_buildit
      scp $dist.tar.gz thunder2:thunder_$dist.tar.gz
      ssh thunder2 "chmod 750 thunder_buildit;./thunder_buildit" &
   fi
fi

#
# Build on yana.
#
rm -f yana
cat <<EOF > yana
#!/bin/sh
if test ! -d /usr/tmp/$user ; then
   mkdir /usr/tmp/$user
fi
if test ! -d /usr/tmp/$user/yana ; then
   mkdir /usr/tmp/$user/yana
fi
rm -rf /usr/tmp/$user/yana/visitbuild
mkdir /usr/tmp/$user/yana/visitbuild
mv yana_$dist.tar.gz /usr/tmp/$user/yana/visitbuild/$dist.tar.gz
cd /usr/tmp/$user/yana/visitbuild
gunzip -c $dist.tar.gz | tar xvf - > buildlog 2>&1
cd $dist/src
ver=\`cat VERSION\`
ver2=\`echo \$ver | tr "." "_"\`
export PATH=\$PATH:/usr/bin/X11
env CXXFLAGS=-O2 ./configure --enable-parallel --enable-visitmodule --enable-slivr >> ../../buildlog 2>&1
make -j 6 >> ../../buildlog 2>&1
svn_bin/visit-bin-dist >> ../../buildlog 2>&1
mv visit\$ver2.linux-x86_64.tar.gz ../..
cd ../..
rm -f resultlog
echo "        build of visit on yana"         > resultlog 2>&1
echo "       ------------------------"        >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
ls -l                                         >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "number of database plugins = "\`ls $dist/src/plugins/databases/libI* | wc -l\` >> resultlog 2>&1
echo "number of operator plugins = "\`ls $dist/src/plugins/operators/libI* | wc -l\` >> resultlog 2>&1
echo "number of plot plugins = "\`ls $dist/src/plugins/plots/libI* | wc -l\` >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "The database plugins:"                  >> resultlog 2>&1
ls $dist/src/plugins/databases/libI* | sed "s/$dist\/src\/plugins\/databases\/libI//" | sed "s/Database.so//" >> resultlog 2>&1
mail  -s "VisIt build ($dist): yana" $emailName < resultlog
EOF

if [ $yana = true ]
then
   if [ $test = no ]
   then
      echo "Building on yana"
      scp yana yana3:yana_buildit
      scp $dist.tar.gz yana3:yana_$dist.tar.gz
      ssh yana3 "chmod 750 yana_buildit;./yana_buildit" &
   fi
fi

#
# Build on xchem.
#
rm -f xchem
cat <<EOF > xchem
#!/bin/sh
PATH=/usr/X11R6/bin:\$PATH
if test ! -d tmp ; then
   mkdir tmp
fi
if test ! -d tmp/$user ; then
   mkdir tmp/$user
fi
if test ! -d tmp/$user/xchem ; then
   mkdir tmp/$user/xchem
fi
rm -rf tmp/$user/xchem/visitbuild
mkdir tmp/$user/xchem/visitbuild
mv xchem_$dist.tar.gz tmp/$user/xchem/visitbuild/$dist.tar.gz
cd tmp/$user/xchem/visitbuild
gunzip -c $dist.tar.gz | tar xvf - > buildlog 2>&1
cd $dist/src
ver=\`cat VERSION\`
ver2=\`echo \$ver | tr "." "_"\`
env CXXFLAGS=-O2 ./configure --enable-parallel --enable-visitmodule >> ../../buildlog 2>&1
make -j 3 >> ../../buildlog 2>&1
svn_bin/visit-bin-dist >> ../../buildlog 2>&1
mv visit\$ver2.linux-x86_64.tar.gz ../..
cd ../..
rm -f resultlog
echo "        build of visit on xchem"        > resultlog 2>&1
echo "       -------------------------"       >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
ls -l                                         >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "number of database plugins = "\`ls $dist/src/plugins/databases/libI* | wc -l\` >> resultlog 2>&1
echo "number of operator plugins = "\`ls $dist/src/plugins/operators/libI* | wc -l\` >> resultlog 2>&1
echo "number of plot plugins = "\`ls $dist/src/plugins/plots/libI* | wc -l\` >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "The database plugins:"                  >> resultlog 2>&1
ls $dist/src/plugins/databases/libI* | sed "s/$dist\/src\/plugins\/databases\/libI//" | sed "s/Database.so//" >> resultlog 2>&1
mail  -s "VisIt build ($dist): xchem" $emailName < resultlog
EOF

if [ $xchem = true ]
then
   if [ $test = no ]
   then
      echo "Building on xchem"
      scp xchem xchem:xchem_buildit
      scp $dist.tar.gz xchem:xchem_$dist.tar.gz
      ssh xchem "chmod 750 xchem_buildit;./xchem_buildit" &
   fi
fi

#
# Build on davinci.
#
rm -f davinci
cat <<EOF > davinci
#!/bin/sh
if test ! -d tmp ; then
   mkdir tmp
fi
if test ! -d tmp/$user ; then
   mkdir tmp/$user
fi
if test ! -d tmp/$user/davinci; then
   mkdir tmp/$user/davinci
fi
rm -rf tmp/$user/davinci/visitbuild
mkdir tmp/$user/davinci/visitbuild
mv davinci_$dist.tar.gz tmp/$user/davinci/visitbuild/$dist.tar.gz
cd tmp/$user/davinci/visitbuild
gunzip -c $dist.tar.gz | tar xvf - > buildlog 2>&1
cd $dist/src
ver=\`cat VERSION\`
ver2=\`echo \$ver | tr "." "_"\`
env CXXFLAGS=-O2 ./configure --enable-parallel --enable-visitmodule --enable-slivr >> ../../buildlog 2>&1
make -j 4 >> ../../buildlog 2>&1
svn_bin/visit-bin-dist >> ../../buildlog 2>&1
mv visit\$ver2.linux-ia64.tar.gz ../..
cd ../..
rm -f resultlog
echo "        build of visit on davinci"      > resultlog 2>&1
echo "       ---------------------------"     >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
ls -l                                         >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "number of database plugins = "\`ls $dist/src/plugins/databases/libI* | wc -l\` >> resultlog 2>&1
echo "number of operator plugins = "\`ls $dist/src/plugins/operators/libI* | wc -l\` >> resultlog 2>&1
echo "number of plot plugins = "\`ls $dist/src/plugins/plots/libI* | wc -l\` >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "The database plugins:"                  >> resultlog 2>&1
ls $dist/src/plugins/databases/libI* | sed "s/$dist\/src\/plugins\/databases\/libI//" | sed "s/Database.so//" >> resultlog 2>&1
mail  -s "VisIt build ($dist): davinci" $emailName < resultlog
EOF

if [ $davinci = true ]
then
   if [ $test = no ]
   then
      echo "Building on davinci"
      scp davinci davinci.nersc.gov:davinci_buildit
      scp $dist.tar.gz davinci.nersc.gov:davinci_$dist.tar.gz
      ssh davinci.nersc.gov "chmod 750 davinci_buildit;./davinci_buildit" &
   fi
fi

#
# Build on ellipse.
#
rm -f ellipse
cat <<EOF > ellipse
#!/bin/sh
if test ! -d tmp ; then
   mkdir tmp
fi
if test ! -d tmp/$user ; then
   mkdir tmp/$user
fi
if test ! -d tmp/$user/ellipse; then
   mkdir tmp/$user/ellipse
fi
rm -rf tmp/$user/ellipse/visitbuild
mkdir tmp/$user/ellipse/visitbuild
mv ellipse_$dist.tar.gz tmp/$user/ellipse/visitbuild/$dist.tar.gz
cd tmp/$user/ellipse/visitbuild
gunzip -c $dist.tar.gz | tar xvf - > buildlog 2>&1
cd $dist/src
ver=\`cat VERSION\`
ver2=\`echo \$ver | tr "." "_"\`
env CXXFLAGS=-O2 ./configure --enable-parallel --enable-visitmodule >> ../../buildlog 2>&1
make -j 2 >> ../../buildlog 2>&1
svn_bin/visit-bin-dist >> ../../buildlog 2>&1
mv visit\$ver2.linux.tar.gz ../..
cd ../..
rm -f resultlog
echo "        build of visit on ellipse"      > resultlog 2>&1
echo "       ---------------------------"     >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
ls -l                                         >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "number of database plugins = "\`ls $dist/src/plugins/databases/libI* | wc -l\` >> resultlog 2>&1
echo "number of operator plugins = "\`ls $dist/src/plugins/operators/libI* | wc -l\` >> resultlog 2>&1
echo "number of plot plugins = "\`ls $dist/src/plugins/plots/libI* | wc -l\` >> resultlog 2>&1
echo ""                                       >> resultlog 2>&1
echo "The database plugins:"                  >> resultlog 2>&1
ls $dist/src/plugins/databases/libI* | sed "s/$dist\/src\/plugins\/databases\/libI//" | sed "s/Database.so//" >> resultlog 2>&1
mail  -s "VisIt build ($dist): ellipse" $emailName < resultlog
EOF

if [ $ellipse = true ]
then
   if [ $test = no ]
   then
      echo "Building on ellipse"
      scp ellipse ellipse.uchicago.edu:ellipse_buildit
      scp $dist.tar.gz ellipse.uchicago.edu:ellipse_$dist.tar.gz
      ssh ellipse.uchicago.edu "chmod 750 ellipse_buildit;./ellipse_buildit" &
   fi
fi

#
# Clean up.
#
if [ $test = no ]
then
   rm -f hoth sunspot quad up pengra thunder yana xchem davinci ellipse
fi
